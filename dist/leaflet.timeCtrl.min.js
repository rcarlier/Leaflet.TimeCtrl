L.TimeCtrl=L.LayerGroup.extend({initialize:function(t,i){this.defaultOptions={text:{position:"bottomleft",title:null,legend:null,exact:"One year",inter:"Beetween",rows:null,value:null},circle:{mini:6,maxi:6,color:"#FF0000",opacity:.5,weight:.5,fillColor:"#FF0000",fillOpacity:.5,popup:!0},data:{year:"year",lat:"lat",lng:"lng",value:"value"}},this._opt=L.Util.extend({},this.defaultOptions,i),this._validateOptions(),this.bounds=null,this.yearSliderMini=null,this.yearSliderMaxi=null,this.timeControl=null,this.minYear=1/0,this.maxYear=-1/0,this.count=0,this.data=t,this._opt.data.mini=1/0,this._opt.data.maxi=-1/0,this.data.forEach(t=>{this.minYear=Math.min(this.minYear,t[this._opt.data.year]),this.maxYear=Math.max(this.maxYear,t[this._opt.data.year]),this._opt.data.mini=Math.min(this._opt.data.mini,t[this._opt.data.value]),this._opt.data.maxi=Math.max(this._opt.data.mini,t[this._opt.data.value])}),this.data.sort((t,i)=>i[this._opt.data.value]-t[this._opt.data.value]),this.circleData=[]},onAdd:function(t){this._map=t,this._createControl(),this._createCircles(),this._updateCircles(),L.LayerGroup.prototype.onAdd.call(this,t)},_validateType:function(t,i,e){this._opt[t]||(this._opt[t]=null),i in this._opt[t]||(this._opt[t][i]=null),typeof this._opt[t][i]!==e&&(console.warn(t+`.${i} option needs to be a ${e} ; default value applyed.`),this._opt[t][i]=this.defaultOptions[t][i])},_validateOptions:function(){this._validateType("text","position","string"),this._validateType("text","title","string"),this._validateType("text","legend","string"),this._validateType("text","exact","string"),this._validateType("text","inter","string"),this._validateType("text","rows","string"),this._validateType("text","value","string"),this._validateType("circle","mini","number"),this._validateType("circle","maxi","number"),this._validateType("circle","color","string"),this._validateType("circle","opacity","number"),this._validateType("circle","weight","number"),this._validateType("circle","fillColor","string"),this._validateType("circle","fillOpacity","number"),this._validateType("circle","popup","boolean"),this._validateType("data","year","string"),this._validateType("data","lat","string"),this._validateType("data","lng","string"),this._validateType("data","value","string"),this._validateType("data","value","string")},_createCircles:function(){this.bounds=L.latLngBounds(),this.data.forEach(i=>{let t=0;t=this._opt.data.mini!=this._opt.data.max?(e=(i[this._opt.data.value]-this._opt.data.mini)/(this._opt.data.maxi-this._opt.data.mini),t=this._opt.circle.mini+(this._opt.circle.maxi-this._opt.circle.mini)*e,Math.max(this._opt.circle.mini,Math.min(this._opt.circle.maxi,t))):this._opt.circle.mini;var e=L.circleMarker([i[this._opt.data.lat],i[this._opt.data.lng]],{color:this._opt.circle.color,opacity:this._opt.circle.opacity,fillColor:this._opt.circle.fillColor,fillOpacity:this._opt.circle.fillOpacity,weight:this._opt.circle.weight,radius:t,interactive:this._opt.circle.popup});if(this._opt.circle.popup){let t="";for(var a in i)t+=`<div class="timeCtrlPopup"><b>${a}</b>: ${i[a]}</div>`;e.bindPopup(t)}this.circleData.push({circle:e,data:i}),this.bounds.extend(e.getLatLng())}),map.fitBounds(this.bounds)},_createControl:function(){this.timeControl=L.control({position:this._opt.text.position}),this.timeControl.onAdd=()=>{var t=L.DomUtil.create("div","timeCtrl"),i=L.DomUtil.create("div"),i=(i.innerHTML="",null!=this._opt.text.title&&(i.innerHTML+=`<div class="timeCtrlTitle">${this._opt.text.title}</div>`),null!=this._opt.text.legend&&(i.innerHTML+=`<div class="timeCtrlLegend">${this._opt.text.legend}</div>`),i.innerHTML+=`
                <div id="rowsLabel" class="timeCtrlRows"></div>
                <div id="valueLabel" class="timeCtrlValue"></div>
            `,t.appendChild(i),L.DomUtil.create("div")),i=(i.innerHTML=`
            <div id="yearMini" class="timeCtrlYearSlider">
                <input 
                    id="yearSliderMini"
                    type="range"
                    min="${this.minYear}"
                    max="${this.maxYear}"
                    step="1"
                    value="${this.minYear}"
                    class="timeCtrlSlider"
                />
                <output id="yearOutputMini" class="timeCtrlOutput">0000</output>
            </div>
            `,this.yearSliderMini=i.querySelector("#yearSliderMini"),t.appendChild(i),L.DomUtil.create("div")),i=(i.innerHTML+=`
            <div id="yearMaxi" class="timeCtrlYearSlider">
                <input 
                    id="yearSliderMaxi"
                    type="range"
                    min="${this.minYear}"
                    max="${this.maxYear}"
                    step="1"
                    value="${this.maxYear}"
                    class="timeCtrlSlider"
                />
                <output id="yearOutputMaxi">0000</output>
            </div>
            `,this.yearSliderMaxi=i.querySelector("#yearSliderMaxi"),t.appendChild(i),L.DomUtil.create("div"));function e(t){t.stopPropagation()}return i.innerHTML=`
                <div class="timeCtrlRadio">
                    <label>
                    <input type="radio" id="timeCtrlViewE" name="timeCtrlView" value="exact"  />
                    ${this._opt.text.exact}
                    </label>
                    <label>
                    <input type="radio" id="timeCtrlViewC" name="timeCtrlView" value="intervale" checked />
                    ${this._opt.text.inter}
                    </label>
                </div>
                `,t.appendChild(i),t.querySelector("#timeCtrlViewE").addEventListener("click",t=>{this._updateCircles()}),t.querySelector("#timeCtrlViewC").addEventListener("click",t=>{this._updateCircles()}),t.addEventListener("mousedown",e),t.addEventListener("click",e),t.addEventListener("dblclick",e),this.yearSliderMini.addEventListener("input",t=>{this._updateCircles()}),this.yearSliderMaxi.addEventListener("input",t=>{this._updateCircles()}),t},this._map?this.timeControl.addTo(this._map):console.warn("La carte Leaflet (_map) n'est pas d√©finie.")},_updateUi:function(){document.querySelector("#yearOutputMini").innerText=this.yearSliderMini.value,document.querySelector("#yearOutputMaxi").innerText=this.yearSliderMaxi.value,null===this._opt.text.rows?document.querySelector("#rowsLabel").style.display="none":document.querySelector("#rowsLabel").innerHTML=`${this._opt.text.rows}: <b>${this.count}</b>`,null===this._opt.text.value?document.querySelector("#valueLabel").style.display="none":document.querySelector("#valueLabel").innerHTML=`${this._opt.text.value}: <b>${this.total}</b>`,"exact"==document.querySelector('input[name="timeCtrlView"]:checked').value?document.querySelector("#yearMaxi").style.display="none":document.querySelector("#yearMaxi").style.display="grid"},_updateCircles:function(){let e=document.querySelector('input[name="timeCtrlView"]:checked').value;this.count=0,this.total=0,this.circleData.forEach(t=>{var i=t.circle,t=t.data;"exact"===e?t[this._opt.data.year]==this.yearSliderMini.value?(this.count++,this.total+=t[this._opt.data.value],map.addLayer(i)):map.removeLayer(i):t[this._opt.data.year]>=this.yearSliderMini.value&&t[this._opt.data.year]<=this.yearSliderMaxi.value?(this.count++,this.total+=t[this._opt.data.value],map.addLayer(i)):map.removeLayer(i)}),this._updateUi()}}),L.timeCtrl=function(t,i={}){return new L.TimeCtrl(t,i)};